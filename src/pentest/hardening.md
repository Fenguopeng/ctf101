# å®‰å…¨åŠ å›º

## SSH

é…ç½®æ–‡ä»¶ `/etc/ssh/sshd_config`

- ssh.socketï¼ˆsystemd socket unitï¼‰
  - è´Ÿè´£â€œç›‘å¬ç«¯å£/åœ°å€â€ã€‚å½“æœ‰è¿æ¥åˆ°æ¥æ—¶ï¼Œsystemd æ‰æŒ‰éœ€å¯åŠ¨ ssh.serviceã€‚
  - å±äºæŒ‰éœ€ï¼ˆon-demandï¼‰æ¿€æ´»çš„æœºåˆ¶ï¼šç©ºé—²æ—¶ä¸å ç”¨ä¸€ä¸ªå¸¸é©»çš„å®ˆæŠ¤è¿›ç¨‹ã€‚

```bash
$ systemctl status ssh.socket
â— ssh.socket - OpenBSD Secure Shell server socket
     Loaded: loaded (]8;;file://serverx/usr/lib/systemd/system/ssh.socket/usr/lib/systemd/system/ssh.socket]8;;; enabled; preset: enabled)
    Drop-In: /run/systemd/generator/ssh.socket.d
             â””â”€]8;;file://serverx/run/systemd/generator/ssh.socket.d/addresses.confaddresses.conf]8;;
     Active: active (running) since Wed 2025-08-20 07:29:48 CST; 5min ago
   Triggers: â— ssh.service
     Listen: [::]:2222 (Stream)
      Tasks: 0 (limit: 1857)
     Memory: 8.0K (peak: 256.0K)
        CPU: 865us
     CGroup: /system.slice/ssh.socket

Aug 20 07:29:48 serverx systemd[1]: Listening on ssh.socket - OpenBSD Secure Shell server socket.
```

- ssh.serviceï¼ˆsystemd service unitï¼‰
  - è´Ÿè´£è¿è¡Œ sshd è¿›ç¨‹ï¼ˆOpenSSH å®ˆæŠ¤è¿›ç¨‹ï¼‰ï¼Œå¤„ç†å®é™…çš„ SSH ä¼šè¯ä¸è®¤è¯ã€‚
  - åœ¨æœªä½¿ç”¨ socket æ¿€æ´»æ—¶ï¼Œå®ƒä¼šå¸¸é©»ç›‘å¬ç«¯å£ï¼›ä½¿ç”¨ socket æ¿€æ´»æ—¶ï¼Œå®ƒç”± ssh.socket è§¦å‘å¯åŠ¨ã€‚

```bash
$ systemctl status ssh
â— ssh.service - OpenBSD Secure Shell server
     Loaded: loaded (]8;;file://serverx/usr/lib/systemd/system/ssh.service/usr/lib/systemd/system/ssh.service]8;;; disabled; preset: enabled)
     Active: active (running) since Wed 2025-08-20 07:29:48 CST; 8min ago
TriggeredBy: â— ssh.socket
       Docs: ]8;;man:sshd(8)man:sshd(8)]8;;
             ]8;;man:sshd_config(5)man:sshd_config(5)]8;;
    Process: 96667 ExecStartPre=/usr/sbin/sshd -t (code=exited, status=0/SUCCESS)
   Main PID: 96669 (sshd)
      Tasks: 1 (limit: 1857)
     Memory: 1.2M (peak: 1.5M)
        CPU: 39ms
     CGroup: /system.slice/ssh.service
             â””â”€96669 "sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups"

Aug 20 07:29:48 serverx systemd[1]: Starting ssh.service - OpenBSD Secure Shell server...
Aug 20 07:29:48 serverx sshd[96669]: Server listening on :: port 2222.
Aug 20 07:29:48 serverx systemd[1]: Started ssh.service - OpenBSD Secure Shell server.
```

- ä¿®æ”¹é»˜è®¤ç«¯å£

é»˜è®¤ç«¯å£ä¸º `22`ï¼Œæ¯”å¦‚ä¿®æ”¹ä¸º`2222`

```
# When systemd socket activation is used (the default), the socket
# configuration must be re-generated after changing Port, AddressFamily, or
# ListenAddress.
#
# For changes to take effect, run:
#
#   systemctl daemon-reload
#   systemctl restart ssh.socket
#
Port 2222
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::
```

é…ç½®ç”Ÿæ•ˆï¼Œéœ€è¦åŠ è½½é…ç½®å¹¶é‡å¯æœåŠ¡

```bash
sudo systemctl daemon-reload
sudo systemctl restart ssh.socket
```

- ç¦ç”¨ root ç”¨æˆ·ç™»å½•

ç¦æ­¢é€šè¿‡ SSH ç›´æ¥ä»¥ root ç™»å½•ï¼Œä»¥é™ä½æœªæˆæƒè®¿é—®çš„é£é™©ã€‚ç›¸åï¼Œåˆ›å»ºå…·æœ‰ sudo æƒé™çš„æ ‡å‡†ç”¨æˆ·è´¦æˆ·æ¥æ‰§è¡Œç®¡ç†ä»»åŠ¡ã€‚è¿™ç§åšæ³•å¯ç¼“è§£é’ˆå¯¹ root è´¦æˆ·çš„æš´åŠ›ç ´è§£æ”»å‡»ã€‚

```bash
sudo adduser <username>
sudo usermod -aG sudo <username>
```

```
PermitRootLogin no
```

```bash
sudo systemctl reload sshd
```

- é™åˆ¶èº«ä»½éªŒè¯æœ€å¤§å°è¯•æ¬¡æ•°

```

```

## Fail2ban

Fail2ban æ˜¯ä¸€ä¸ªåŸºäºæ—¥å¿—çš„å…¥ä¾µé˜²æŠ¤å·¥å…·ï¼Œå¸¸ç”¨äºé˜»æ­¢æš´åŠ›ç ´è§£ï¼ˆå¦‚ SSHã€FTPã€HTTP åŸºæœ¬è®¤è¯ç­‰ï¼‰ã€‚

å·¥ä½œåŸç†ï¼šç›‘æ§æœåŠ¡æ—¥å¿— â†’ åŒ¹é…å¤±è´¥æ¨¡å¼ï¼ˆfilterï¼‰â†’ è§¦å‘å°ç¦åŠ¨ä½œï¼ˆactionï¼‰ï¼Œé€šå¸¸é€šè¿‡ iptables/nftables ä¸´æ—¶å° IPã€‚

```bash
# å®‰è£…
sudo apt update
sudo apt install fail2ban

# å¯åŠ¨å¹¶å¼€æœºè‡ªå¯
sudo systemctl enable --now fail2ban

# æŸ¥çœ‹çŠ¶æ€ä¸æ—¥å¿—
systemctl status fail2ban
sudo journalctl -u fail2ban -f

sudo fail2ban-client status
```

```bash
sudo fail2ban-client get sshd bantime
sudo fail2ban-client get sshd findtime
sudo fail2ban-client get sshd maxretry
```
